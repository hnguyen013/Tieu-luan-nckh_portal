{% extends "portal/admin_base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}
{% block menu_projects_active %} active{% endblock %}
{% block page_header %}{{ title }}{% endblock %}
{% block breadcrumb %}Trang chủ / Đề tài / {{ title }}{% endblock %}

{% block content %}

<form method="post"
      enctype="multipart/form-data"
      class="form-vertical project-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
        <div class="form-errors">
            {{ form.non_field_errors }}
        </div>
    {% endif %}

    <!-- ================= THÔNG TIN ĐỀ TÀI ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">Thông tin đề tài</div>

        <div class="form-group">
            <label for="{{ form.code.id_for_label }}">
                Mã đề tài <span class="required">*</span>
            </label>
            {{ form.code }}
            {% if form.code.errors %}
                <div class="field-error">{{ form.code.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">
                Tên đề tài <span class="required">*</span>
            </label>
            {{ form.title }}
            {% if form.title.errors %}
                <div class="field-error">{{ form.title.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.project_level.id_for_label }}">
                Cấp đề tài <span class="required">*</span>
            </label>
            {{ form.project_level }}
            {% if form.project_level.errors %}
                <div class="field-error">{{ form.project_level.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.research_field.id_for_label }}">
                Lĩnh vực <span class="required">*</span>
            </label>
            {{ form.research_field }}
            {% if form.research_field.errors %}
                <div class="field-error">{{ form.research_field.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.host_organization.id_for_label }}">
                Đơn vị chủ trì <span class="required">*</span>
            </label>
            {{ form.host_organization }}
            {% if form.host_organization.errors %}
                <div class="field-error">{{ form.host_organization.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.implementing_organization.id_for_label }}">
                Đơn vị thực hiện <span class="required">*</span>
            </label>
            {{ form.implementing_organization }}
            {% if form.implementing_organization.errors %}
                <div class="field-error">{{ form.implementing_organization.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.objectives.id_for_label }}">Mục tiêu</label>
            {{ form.objectives }}
            {% if form.objectives.errors %}
                <div class="field-error">{{ form.objectives.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.summary.id_for_label }}">Nội dung</label>
            {{ form.summary }}
            {% if form.summary.errors %}
                <div class="field-error">{{ form.summary.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.budget.id_for_label }}">Kinh phí</label>
            {{ form.budget }}
            {% if form.budget.errors %}
                <div class="field-error">{{ form.budget.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.category.id_for_label }}">
                Phân loại <span class="required">*</span>
            </label>
            {{ form.category }}
            {% if form.category.errors %}
                <div class="field-error">{{ form.category.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.start_year.id_for_label }}">
                Ngày bắt đầu <span class="required">*</span>
            </label>
            {{ form.start_year }}
            {% if form.start_year.errors %}
                <div class="field-error">{{ form.start_year.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.end_year.id_for_label }}">
                Ngày kết thúc <span class="required">*</span>
            </label>
            {{ form.end_year }}
            {% if form.end_year.errors %}
                <div class="field-error">{{ form.end_year.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.faculty.id_for_label }}">
                Khoa <span class="required">*</span>
            </label>
            {{ form.faculty }}
            {% if form.faculty.errors %}
                <div class="field-error">{{ form.faculty.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.academic_year.id_for_label }}">
                Năm học <span class="required">*</span>
            </label>
            {{ form.academic_year }}
            {% if form.academic_year.errors %}
                <div class="field-error">{{ form.academic_year.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.project_type.id_for_label }}">
                Loại đề tài <span class="required">*</span>
            </label>
            {{ form.project_type }}
            {% if form.project_type.errors %}
                <div class="field-error">{{ form.project_type.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.status.id_for_label }}">
                Trạng thái <span class="required">*</span>
            </label>
            {{ form.status }}
            {% if form.status.errors %}
                <div class="field-error">{{ form.status.errors|striptags }}</div>
            {% endif %}
        </div>
    </div>

    <!-- ================= GIẢNG VIÊN HƯỚNG DẪN ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">Giảng viên hướng dẫn</div>

        <div class="form-group">
            <label>Chọn giảng viên <span class="required">*</span></label>

            <input type="text"
                   id="lecturerFilter"
                   class="filter-input"
                   placeholder="Gõ để tìm tên giảng viên...">

            {{ form.lecturer_ids }}

            {% if form.lecturer_ids.errors %}
                <div class="field-error">{{ form.lecturer_ids.errors|striptags }}</div>
            {% endif %}

            <div class="help-text">
                Có thể chọn nhiều giảng viên (giữ Ctrl / Shift).
            </div>
        </div>
    </div>

    <!-- ================= SINH VIÊN THAM GIA ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">Sinh viên tham gia</div>

        <div class="form-two-columns">

            <!-- CỘT TRÁI: DANH SÁCH ĐÃ CHỌN -->
            <div class="selected-box">
                <ul id="selectedStudents" class="selected-list selected-chip-list"></ul>
            </div>

            <!-- CỘT PHẢI: SELECT -->
            <div class="form-group">
                <label>Chọn sinh viên <span class="required">*</span></label>

                <input type="text"
                       id="studentFilter"
                       class="filter-input"
                       placeholder="Gõ để tìm MSSV / tên sinh viên...">

                {{ form.student_ids }}

                {% if form.student_ids.errors %}
                    <div class="field-error">{{ form.student_ids.errors|striptags }}</div>
                {% endif %}

                <div class="help-text">
                    Có thể chọn nhiều sinh viên (giữ Ctrl / Shift).
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.leader_student_id.id_for_label }}">
                Trưởng nhóm
            </label>
            {{ form.leader_student_id }}
            {% if form.leader_student_id.errors %}
                <div class="field-error">{{ form.leader_student_id.errors|striptags }}</div>
            {% endif %}
        </div>
    </div>

    <!-- ================= FILE ĐÍNH KÈM ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">File đính kèm</div>

        <div class="form-group">
            <label for="{{ form.attachments.id_for_label }}">
                {{ form.attachments.label }}
            </label>
            {{ form.attachments }}
            {% if form.attachments.errors %}
                <div class="field-error">{{ form.attachments.errors|striptags }}</div>
            {% endif %}
            <div class="help-text">
                Có thể chọn nhiều file (đề cương / báo cáo).
            </div>
        </div>

        {% if project %}
            <div class="form-group">
                <label>File đã đính kèm</label>
                {% if project.attachments.all %}
                    <ul class="attached-files">
                        {% for f in project.attachments.all %}
                            <li>
                                <a href="{{ f.file.url }}" target="_blank">
                                    {{ f.original_name }}
                                </a>
                                <small>
                                    ({{ f.uploaded_at|date:"d/m/Y H:i" }})
                                </small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="help-text">Chưa có file đính kèm.</div>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% if project and project.status == 'ACCEPTED' and council_form and member_formset %}
    <!-- ================= THÔNG TIN HỘI ĐỒNG CHẤM ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">Thông tin hội đồng chấm</div>

        {% if council_form.non_field_errors %}
            <div class="form-errors">
                {{ council_form.non_field_errors }}
            </div>
        {% endif %}

        <div class="form-group">
            <label for="{{ council_form.council_title.id_for_label }}">
                Tên hội đồng <span class="required">*</span>
            </label>
            {{ council_form.council_title }}
            {% if council_form.council_title.errors %}
                <div class="field-error">{{ council_form.council_title.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ council_form.grading_date.id_for_label }}">
                Ngày chấm
            </label>
            {{ council_form.grading_date }}
            {% if council_form.grading_date.errors %}
                <div class="field-error">{{ council_form.grading_date.errors|striptags }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ council_form.notes.id_for_label }}">
                Ghi chú
            </label>
            {{ council_form.notes }}
            {% if council_form.notes.errors %}
                <div class="field-error">{{ council_form.notes.errors|striptags }}</div>
            {% endif %}
        </div>
    </div>

    <!-- ================= THÀNH VIÊN HỘI ĐỒNG & ĐIỂM ================= -->
    <div class="admin-form-card">
        <div class="admin-form-title">Thành viên hội đồng & điểm</div>

        {{ member_formset.non_form_errors }}
        {{ member_formset.management_form }}

        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width: 35%;">Giảng viên</th>
                    <th style="width: 30%;">Vai trò</th>
                    <th style="width: 20%;">Điểm thành phần</th>
                    <th style="width: 10%;">Xóa</th>
                </tr>
            </thead>
            <tbody>
                {% for f in member_formset %}
                    <tr>
                        <td>
                            {{ f.lecturer }}
                            {% if f.lecturer.errors %}
                                <div class="field-error">{{ f.lecturer.errors|striptags }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ f.role }}
                            {% if f.role.errors %}
                                <div class="field-error">{{ f.role.errors|striptags }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ f.component_score }}
                            {% if f.component_score.errors %}
                                <div class="field-error">{{ f.component_score.errors|striptags }}</div>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if f.instance.pk %}
                                {{ f.DELETE }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="help-text">
            • Mỗi giảng viên chỉ được xuất hiện 1 lần trong hội đồng<br>
            • Điểm từ 0 đến 10 (có thể để trống nếu chưa chấm)
        </div>
    </div>
{% endif %}
    <!-- ================= ACTION ================= -->
    <button type="submit" class="btn-primary">
        {{ submit_label|default:"Lưu đề tài" }}
    </button>
    <a href="{% url 'portal:admin-project-list' %}" class="btn-secondary">
        Hủy
    </a>
</form>

<script>
(function () {
    function attachFilter(inputId, selectId) {
        const filter = document.getElementById(inputId);
        const select = document.getElementById(selectId);
        if (!filter || !select) return;

        const allOptions = Array.from(select.options).map(o => ({
            value: o.value,
            text: o.text
        }));

        const getSelected = () =>
            new Set(Array.from(select.selectedOptions).map(o => o.value));

        filter.addEventListener("input", function () {
            const q = filter.value.trim().toLowerCase();
            const selected = getSelected();

            select.innerHTML = "";
            allOptions
                .filter(o => !q || o.text.toLowerCase().includes(q))
                .forEach(o => {
                    const opt = new Option(o.text, o.value);
                    if (selected.has(o.value)) opt.selected = true;
                    select.add(opt);
                });
        });
    }

    attachFilter("studentFilter", "id_student_ids");
    attachFilter("lecturerFilter", "id_lecturer_ids");
})();
</script>
<script>
(function () {
    const select = document.getElementById("id_student_ids");
    const list = document.getElementById("selectedStudents");

    if (!select || !list) return;

    function renderSelected() {
        const selected = Array.from(select.selectedOptions);
        const leader = document.getElementById("id_leader_student_id")?.value;

        list.innerHTML = "";

        if (selected.length === 0) {
            const li = document.createElement("li");
            li.className = "empty";
            li.textContent = "Chưa chọn sinh viên nào";
            list.appendChild(li);
            return;
        }

        selected.forEach(opt => {
            const li = document.createElement("li");
            li.textContent = opt.text;

            if (leader && opt.value === leader) {
                li.classList.add("leader");
                li.textContent += " ★ Trưởng nhóm";
            }

            list.appendChild(li);
        });
    }

    select.addEventListener("change", renderSelected);
    renderSelected();
})();
</script>

{% endblock %}
